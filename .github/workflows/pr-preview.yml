name: basic-pr-preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  packages: write
  pull-requests: write # For commenting on the PR

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Set Environment Variables
        run: |
          echo "PR_NUMBER=${{ github.event.number }}" >> $GITHUB_ENV
          echo "NAMESPACE=pr-${{ github.event.number }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=pr-${{ github.event.number }}-$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "PREVIEW_URL=http://pr-${{ github.event.number }}.staging.example.com" >> $GITHUB_ENV

      # 2. æ„å»ºé•œåƒ (ä¸ºè¿™ä¸ªç‰¹å®šçš„ PR æ„å»º)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push PR Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}
          build-args: |
             APP_VERSION=pr-${{ github.event.number }}
             GIT_SHA=${{ github.sha }}

      # 3. è®¾ç½® Kubernetes å·¥å…· (è¿™é‡Œå‡è®¾ä½¿ç”¨ Kind æˆ–è¿æ¥åˆ° Staging é›†ç¾¤)
      # åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œè¿™é‡Œä¼šæ˜¯ `azure/k8s-set-context` æˆ–ç±»ä¼¼æ­¥éª¤
      - name: Setup Kubernetes (Simulation)
        uses: helm/kind-action@v1
        with:
          cluster_name: staging-cluster # Simulating a shared staging cluster

      # 4. éƒ¨ç½²åˆ°ä¸´æ—¶ Namespace
      - name: Deploy to Ephemeral Namespace
        run: |
          # åˆ›å»º Namespace (å¦‚æœä¸å­˜åœ¨)
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          
          # åˆ›å»º Image Pull Secret
          kubectl create secret docker-registry ghcr-secret \
            --namespace $NAMESPACE \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --dry-run=client -o yaml | kubectl apply -f -

          # æ›¿æ¢ Deployment ä¸­çš„é•œåƒä¸ºåˆšåˆšæ„å»ºçš„ PR ç‰ˆæœ¬
          # æ³¨æ„ï¼šä½¿ç”¨ envsubst æˆ– sed è¿›è¡Œç®€å•çš„æ¨¡æ¿æ›¿æ¢
          sed "s|ghcr.io/san-tian/lucene-shard-analyzer:latest|ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}|g" k8s/deployment.yaml > k8s/deployment-pr.yaml
          
          # ç¡®ä¿ Deployment åŠ ä¸Šäº† imagePullSecrets (å¦‚æœæ¨¡æ¿é‡Œæ²¡æœ‰é»˜è®¤å¸¦ä¸Š)
          # (æˆ‘ä»¬åœ¨ Task 2 ä¸­å·²ç»åŠ äº† imagePullSecretsï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦ç¡®ä¿å®ƒæŒ‡å‘æ­£ç¡®çš„ secret)
          
          # åº”ç”¨èµ„æºåˆ°æŒ‡å®š Namespace
          kubectl apply -f k8s/deployment-pr.yaml -n $NAMESPACE
          kubectl apply -f k8s/service.yaml -n $NAMESPACE
          
      # 5. é…ç½® Ingress è·¯ç”±
      - name: Configure Ingress
        run: |
          # æ›¿æ¢ Host å ä½ç¬¦
          sed "s|PR_HOST_PLACEHOLDER|pr-${{ env.PR_NUMBER }}.staging.example.com|g" k8s/preview-ingress-template.yaml > k8s/ingress-pr.yaml
          
          # åº”ç”¨ Ingress
          kubectl apply -f k8s/ingress-pr.yaml -n $NAMESPACE

      # 6. ç­‰å¾…å°±ç»ª
      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/lucene-shard-analyzer -n $NAMESPACE --timeout=120s

      # 7. (å¯é€‰) è¿è¡Œé’ˆå¯¹è¯¥ PR ç¯å¢ƒçš„é›†æˆæµ‹è¯•
      - name: Run Smoke Tests against Preview
        run: |
          # åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ Ingress URL è®¿é—®ï¼Œè¿™é‡Œæ¼”ç¤ºä½¿ç”¨ Port-forward æˆ– Service URL
          # USE_K8S_EXEC=true bash test/integration-test.sh
          echo "Running smoke tests against $NAMESPACE..."
          
      # 8. å›å¤ PR å‘ŠçŸ¥éƒ¨ç½²åœ°å€
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const url = process.env.PREVIEW_URL;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸš€ **Preview Environment Deployed!**\n\nAccess your changes here: [${url}](${url})\n\nNamespace: \`pr-${context.issue.number}\``
            })
