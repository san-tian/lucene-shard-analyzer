name: k8s-deploy-and-test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: read
  packages: read

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # 创建一个本地 Kubernetes 集群 (使用 kind)
      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
      
      # 登录 GHCR 以拉取镜像
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # 创建 imagePullSecret 供 K8s 使用
      - name: Create image pull secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }}
      
      # 部署到 Kubernetes
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
      
      # 等待 deployment 就绪
      - name: Wait for deployment to be ready
        run: |
          echo "Waiting for deployment to be ready..."
          kubectl rollout status deployment/lucene-shard-analyzer --timeout=180s
      
      # 设置端口转发
      - name: Setup port forwarding
        run: |
          kubectl port-forward svc/lucene-shard-analyzer 8080:80 &
          sleep 5
      
      # 运行统一的集成测试脚本
      - name: Run Integration Tests
        run: |
          chmod +x test/integration-test.sh
          # 使用 USE_K8S_EXEC=true 以便在 CI 中准确验证 K8s Service 的负载均衡
          USE_K8S_EXEC=true bash test/integration-test.sh
        env:
          BASE_URL: http://localhost:8080
      
      # 显示最终状态
      - name: Show final cluster state
        if: always()
        run: |
          echo "=== Final Cluster State ==="
          echo ""
          echo "Pods:"
          kubectl get pods -l app=lucene-shard-analyzer -o wide
          echo ""
          echo "Services:"
          kubectl get svc lucene-shard-analyzer
          echo ""
          echo "Endpoints:"
          kubectl get endpoints lucene-shard-analyzer
          echo ""
          echo "Recent pod logs (last 20 lines from first pod):"
          POD=$(kubectl get pods -l app=lucene-shard-analyzer -o jsonpath='{.items[0].metadata.name}')
          kubectl logs "$POD" --tail=20 || true
